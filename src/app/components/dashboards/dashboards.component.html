<div class="dashboards-container">
  <!-- Header -->
  <header class="dashboards-header">
    <div class="header-left">
      <button mat-icon-button class="back-btn" (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <img src="assets/images/MIKHUY.png" alt="MIKHUY Logo" class="header-logo">
    </div>

    <div class="header-center">
      <button mat-raised-button class="dashboard-btn">
        <mat-icon>bar_chart</mat-icon>
        DASHBOARDS
      </button>
    </div>

    <div class="header-right">
      <button mat-icon-button class="icon-btn notifications-btn" [matMenuTriggerFor]="notificationMenu">
        <mat-icon [matBadge]="notificationCount" [matBadgeHidden]="notificationCount === 0" matBadgeColor="warn">notifications</mat-icon>
      </button>

      <mat-menu #notificationMenu="matMenu" class="notification-menu">
        <div class="notification-header">
          <h3>Notificaciones</h3>
        </div>
        <div class="notification-content">
          <div class="empty-notifications" *ngIf="!dashboardData || dashboardData.notificaciones.length === 0">
            <mat-icon>notifications_off</mat-icon>
            <p>No hay notificaciones nuevas</p>
          </div>
          <div *ngFor="let notif of dashboardData?.notificaciones" class="notification-item">
            <mat-icon>{{ notif.tipo === 'progreso' ? 'trending_up' : 'emoji_events' }}</mat-icon>
            <div>
              <strong>{{ notif.titulo }}</strong>
              <p>{{ notif.mensaje }}</p>
            </div>
          </div>
        </div>
      </mat-menu>

      <button mat-icon-button class="icon-btn" [matMenuTriggerFor]="menu">
        <mat-icon>menu</mat-icon>
      </button>

      <mat-menu #menu="matMenu" class="user-menu">
        <button mat-menu-item (click)="openProfile()">
          <mat-icon>person</mat-icon>
          <span>Perfil</span>
        </button>
        <button mat-menu-item (click)="logout()">
          <mat-icon>logout</mat-icon>
          <span>Salir</span>
        </button>
      </mat-menu>
    </div>
  </header>

  <!-- Loading Spinner -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner></mat-spinner>
    <p>Cargando datos...</p>
  </div>

  <!-- Error Message -->
  <div class="error-container" *ngIf="error && !loading">
    <mat-icon>error_outline</mat-icon>
    <h3>{{ error }}</h3>
    <button mat-raised-button color="primary" (click)="ngOnInit()">
      <mat-icon>refresh</mat-icon>
      Reintentar
    </button>
  </div>

  <!-- Main Content -->
  <div class="dashboards-content" *ngIf="!loading && !error">

    <!-- Sidebar con lista de estudiantes (solo para profesores) -->
    <div class="sidebar" *ngIf="isTeacher">
      <!-- Search -->
      <div class="search-box">
        <mat-icon>search</mat-icon>
        <input type="text"
               placeholder="Buscar estudiante"
               [(ngModel)]="searchQuery"
               (input)="searchStudents()">
      </div>

      <!-- Student List -->
      <mat-list class="student-list">
        <mat-list-item *ngFor="let student of filteredStudents"
                       [class.active]="selectedStudent?.id === student.id"
                       (click)="selectStudent(student)">
          <div class="student-item">
            <div class="student-avatar">
              <img [src]="getAvatarUrl(student)"
                   [alt]="student.nombre"
                   (error)="onAvatarError($event)">
              <mat-icon *ngIf="!student.avatar">account_circle</mat-icon>
            </div>
            <div class="student-info">
              <h4>{{student.nombre}} {{student.apellido}}</h4>
              <p>{{student.grado}} - Secci√≥n {{student.seccion}}</p>
              <span class="points-badge">{{student.puntosAcumulados || 0}} pts</span>
            </div>
          </div>
        </mat-list-item>
      </mat-list>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-main" *ngIf="selectedStudent && dashboardData">

      <!-- Student Profile Card -->
      <mat-card class="profile-summary">
        <div class="profile-content">
          <div class="profile-avatar">
            <img [src]="getAvatarUrl(selectedStudent)"
                 [alt]="selectedStudent.nombre"
                 (error)="onAvatarError($event)">
            <mat-icon *ngIf="!selectedStudent.avatar">account_circle</mat-icon>
          </div>
          <div class="profile-details">
            <h2>{{selectedStudent.nombre}} {{selectedStudent.apellido}}</h2>
            <div class="profile-stats">
              <div class="stat-item">
                <span class="label">Edad:</span>
                <span class="value">{{selectedStudent.edad}} a√±os</span>
              </div>
              <div class="stat-item">
                <span class="label">Talla:</span>
                <span class="value">{{selectedStudent.talla}}</span>
              </div>
              <div class="stat-item">
                <span class="label">Peso:</span>
                <span class="value">{{selectedStudent.peso}}</span>
              </div>
              <div class="stat-item">
                <span class="label">Grado:</span>
                <span class="value">{{selectedStudent.grado}} - {{selectedStudent.seccion}}</span>
              </div>
              <div class="stat-item">
                <span class="label">Puntos:</span>
                <span class="value highlight">{{dashboardData.estudiante.puntosAcumulados}}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="profile-actions">
          <button mat-raised-button class="download-btn" (click)="descargarReporte()">
            <mat-icon>download</mat-icon>
            Descargar reporte
          </button>
          <button mat-raised-button class="email-btn" (click)="enviarCorreo()">
            <mat-icon>email</mat-icon>
            Enviar por correo
          </button>
        </div>
      </mat-card>

      <!-- Estad√≠sticas Generales -->
      <div class="stats-grid">
        <mat-card class="stat-card">
          <mat-icon class="stat-icon points">emoji_events</mat-icon>
          <div class="stat-content">
            <h3>{{dashboardData.estadisticas.puntosGanados}}</h3>
            <p>Puntos Ganados</p>
          </div>
        </mat-card>

        <mat-card class="stat-card">
          <mat-icon class="stat-icon games">videogame_asset</mat-icon>
          <div class="stat-content">
            <h3>{{dashboardData.estadisticas.juegosCompletados}}</h3>
            <p>Juegos Completados</p>
          </div>
        </mat-card>

        <mat-card class="stat-card">
          <mat-icon class="stat-icon sessions">schedule</mat-icon>
          <div class="stat-content">
            <h3>{{dashboardData.estadisticas.totalSesiones}}</h3>
            <p>Total Sesiones</p>
          </div>
        </mat-card>

        <mat-card class="stat-card">
          <mat-icon class="stat-icon ranking">leaderboard</mat-icon>
          <div class="stat-content">
            <h3>#{{dashboardData.estadisticas.posicionRanking}}</h3>
            <p>Posici√≥n Ranking</p>
          </div>
        </mat-card>
      </div>

      <!-- üéÆ GR√ÅFICOS DE JUEGOS -->
      <div class="charts-grid">

        <!-- Gr√°fico 1: Conocimiento Nutricional (Desaf√≠o Nutrimental) -->
        <mat-card class="chart-card" *ngIf="getJuegoData('Desaf√≠o Nutrimental') as nutrimental">
          <mat-card-header>
            <mat-icon class="info-icon" matTooltip="Resultados del Desaf√≠o Nutrimental">info</mat-icon>
            <mat-card-title>Conocimiento Nutricional</mat-card-title>
            <span class="data-source">Datos del Desaf√≠o Nutrimental</span>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <div class="knowledge-stats">
                <div class="stat-circle">
                  <svg viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="40" class="stat-bg"/>
                    <circle cx="50" cy="50" r="40" class="stat-progress"
                            [attr.stroke-dasharray]="(calcularPorcentajeProgreso(nutrimental) * 2.51) + ' 251'"
                            [style.stroke]="getColorByProgress(calcularPorcentajeProgreso(nutrimental))"/>
                    <text x="50" y="55" class="stat-text">{{calcularPorcentajeProgreso(nutrimental)}}%</text>
                  </svg>
                  <p>Progreso</p>
                </div>
                <div class="knowledge-details">
                  <div class="detail-item">
                    <mat-icon>emoji_events</mat-icon>
                    <div>
                      <strong>Nivel {{nutrimental.nivelActual || 0}}/{{nutrimental.maxNiveles}}</strong>
                      <span>{{nutrimental.puntosGanados || 0}} puntos</span>
                    </div>
                  </div>
                  <div class="detail-item">
                    <mat-icon>replay</mat-icon>
                    <div>
                      <strong>Veces jugado</strong>
                      <span>{{nutrimental.vecesJugado || 0}} veces</span>
                    </div>
                  </div>
                  <div class="detail-item" [class.success]="nutrimental.completado">
                    <mat-icon>{{nutrimental.completado ? 'check_circle' : 'pending'}}</mat-icon>
                    <div>
                      <strong>{{nutrimental.completado ? '¬°Completado!' : 'En progreso'}}</strong>
                      <span>{{nutrimental.completado ? 'Juego terminado' : 'Contin√∫a jugando'}}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Gr√°fico 2: Distribuci√≥n de Macronutrientes (si hay an√°lisis) -->
        <mat-card class="chart-card" *ngIf="dashboardData.ultimoAnalisis">
          <mat-card-header>
            <mat-card-title>Distribuci√≥n de Macronutrientes</mat-card-title>
            <span class="data-source">An√°lisis Nutricional</span>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <svg viewBox="0 0 200 200" class="donut-chart">
                <circle cx="100" cy="100" r="60" class="donut-segment protein"
                        [attr.stroke-dasharray]="getCircleSegment(dashboardData.ultimoAnalisis.proteinasPorcentaje) + ' 377'"/>
                <circle cx="100" cy="100" r="60" class="donut-segment carbs"
                        [attr.stroke-dasharray]="getCircleSegment(dashboardData.ultimoAnalisis.carbohidratosPorcentaje) + ' 377'"
                        [attr.stroke-dashoffset]="-getCircleSegment(dashboardData.ultimoAnalisis.proteinasPorcentaje)"/>
                <circle cx="100" cy="100" r="60" class="donut-segment fat"
                        [attr.stroke-dasharray]="getCircleSegment(dashboardData.ultimoAnalisis.grasasPorcentaje) + ' 377'"
                        [attr.stroke-dashoffset]="-(getCircleSegment(dashboardData.ultimoAnalisis.proteinasPorcentaje) + getCircleSegment(dashboardData.ultimoAnalisis.carbohidratosPorcentaje))"/>
                <text x="100" y="105" class="donut-center">100%</text>
              </svg>
              <div class="chart-legend">
                <div class="legend-item">
                  <span class="legend-color protein-color"></span>
                  <span>Prote√≠nas {{dashboardData.ultimoAnalisis.proteinasPorcentaje}}%</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color carbs-color"></span>
                  <span>Carbohidratos {{dashboardData.ultimoAnalisis.carbohidratosPorcentaje}}%</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color fat-color"></span>
                  <span>Grasas {{dashboardData.ultimoAnalisis.grasasPorcentaje}}%</span>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Gr√°fico 3: Progreso Reto 7 D√≠as -->
        <mat-card class="chart-card" *ngIf="getJuegoData('Reto 7 D√≠as') as reto7dias">
          <mat-card-header>
            <mat-card-title>Reto 7 D√≠as - Registro Alimenticio</mat-card-title>
            <span class="data-source">Datos del Reto 7 D√≠as</span>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <div class="game-progress">
                <div class="progress-header">
                  <mat-icon class="game-icon">restaurant</mat-icon>
                  <div>
                    <h3>{{reto7dias.nivelActual || 0}} de {{reto7dias.maxNiveles}} d√≠as completados</h3>
                    <p>{{reto7dias.puntosGanados || 0}} puntos acumulados</p>
                  </div>
                </div>
                <div class="progress-bar-container">
                  <div class="progress-bar" [style.width.%]="calcularPorcentajeProgreso(reto7dias)"></div>
                </div>
                <div class="game-stats">
                  <div class="game-stat-item">
                    <mat-icon>calendar_today</mat-icon>
                    <span>Jugado {{reto7dias.vecesJugado || 0}} veces</span>
                  </div>
                  <div class="game-stat-item">
                    <mat-icon>{{reto7dias.completado ? 'check_circle' : 'hourglass_empty'}}</mat-icon>
                    <span>{{reto7dias.completado ? 'Completado' : 'En progreso'}}</span>
                  </div>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Gr√°fico 4: Etapa de Cambio (Coach Expr√©s) -->
        <mat-card class="chart-card" *ngIf="dashboardData.ultimoAnalisis && dashboardData.ultimoAnalisis.etapaCambio">
          <mat-card-header>
            <mat-card-title>Etapa de Cambio Conductual</mat-card-title>
            <span class="data-source">Datos del Coach Expr√©s</span>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <div class="stage-indicator">
                <div class="stage-circle" [class.active]="dashboardData.ultimoAnalisis.etapaCambio === 'Pre-contemplaci√≥n'">
                  <span class="stage-number">1</span>
                  <p>Pre-contemplaci√≥n</p>
                </div>
                <div class="stage-connector" [class.active]="isStageActiveOrPast('Contemplaci√≥n')"></div>
                <div class="stage-circle" [class.active]="dashboardData.ultimoAnalisis.etapaCambio === 'Contemplaci√≥n'">
                  <span class="stage-number">2</span>
                  <p>Contemplaci√≥n</p>
                </div>
                <div class="stage-connector" [class.active]="isStageActiveOrPast('Preparaci√≥n')"></div>
                <div class="stage-circle" [class.active]="dashboardData.ultimoAnalisis.etapaCambio === 'Preparaci√≥n'">
                  <span class="stage-number">3</span>
                  <p>Preparaci√≥n</p>
                </div>
                <div class="stage-connector" [class.active]="isStageActiveOrPast('Acci√≥n')"></div>
                <div class="stage-circle" [class.active]="dashboardData.ultimoAnalisis.etapaCambio === 'Acci√≥n'">
                  <span class="stage-number">4</span>
                  <p>Acci√≥n</p>
                </div>
                <div class="stage-connector" [class.active]="dashboardData.ultimoAnalisis.etapaCambio === 'Mantenimiento'"></div>
                <div class="stage-circle" [class.active]="dashboardData.ultimoAnalisis.etapaCambio === 'Mantenimiento'">
                  <span class="stage-number">5</span>
                  <p>Mantenimiento</p>
                </div>
              </div>
              <div class="current-stage-info">
                <mat-icon>psychology</mat-icon>
                <div>
                  <strong>Etapa Actual: {{dashboardData.ultimoAnalisis.etapaCambio}}</strong>
                  <p *ngIf="dashboardData.ultimoAnalisis.porcentajeAciertos">
                    Conocimiento: {{dashboardData.ultimoAnalisis.porcentajeAciertos}}% de aciertos
                  </p>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Gr√°fico 5: Progreso Coach Expr√©s -->
        <mat-card class="chart-card" *ngIf="getJuegoData('Coach Expr√©s') as coach">
          <mat-card-header>
            <mat-card-title>Coach Expr√©s - Evaluaci√≥n Psicol√≥gica</mat-card-title>
            <span class="data-source">Datos del Coach Expr√©s</span>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <div class="game-progress">
                <div class="progress-header">
                  <mat-icon class="game-icon">psychology</mat-icon>
                  <div>
                    <h3>Nivel {{coach.nivelActual || 0}} de {{coach.maxNiveles}}</h3>
                    <p>{{coach.puntosGanados || 0}} puntos acumulados</p>
                  </div>
                </div>
                <div class="progress-bar-container">
                  <div class="progress-bar coach" [style.width.%]="calcularPorcentajeProgreso(coach)"></div>
                </div>
                <div class="game-stats">
                  <div class="game-stat-item">
                    <mat-icon>psychology</mat-icon>
                    <span>Evaluaciones: {{coach.vecesJugado || 0}}</span>
                  </div>
                  <div class="game-stat-item">
                    <mat-icon>{{coach.completado ? 'check_circle' : 'pending'}}</mat-icon>
                    <span>{{coach.completado ? 'Evaluaci√≥n completa' : 'En evaluaci√≥n'}}</span>
                  </div>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Gr√°fico 6: Comparativa de Juegos -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>Comparativa de Juegos</mat-card-title>
            <span class="data-source">Resumen General</span>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <div class="games-comparison">
                <div class="game-comparison-item" *ngFor="let juego of dashboardData.juegos">
                  <div class="game-name">
                    <mat-icon>{{getGameIcon(juego.nombre)}}</mat-icon>
                    <span>{{juego.nombre}}</span>
                  </div>
                  <div class="game-bar-container">
                    <div class="game-bar" 
                         [style.width.%]="calcularPorcentajeProgreso(juego)"
                         [class.completed]="juego.completado">
                    </div>
                  </div>
                  <span class="game-percentage">{{calcularPorcentajeProgreso(juego)}}%</span>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

      </div>

      <!-- √öltimas Sesiones de Juego -->
      <mat-card class="recent-sessions">
        <mat-card-header>
          <mat-card-title>√öltimas Sesiones de Juego</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="session-list" *ngIf="dashboardData.ultimasSesiones.length > 0">
            <div class="session-item" *ngFor="let sesion of dashboardData.ultimasSesiones">
              <mat-icon class="session-icon" [class.completed]="sesion.completado">
                {{sesion.completado ? 'check_circle' : 'pending'}}
              </mat-icon>
              <div class="session-details">
                <h4>{{sesion.juegoNombre}}</h4>
                <p>Nivel {{sesion.nivelJugado}} ‚Ä¢ {{sesion.tiempoJugadoFormato}}</p>
              </div>
              <div class="session-points">
                <span>+{{sesion.puntosObtenidos}} pts</span>
                <small>{{sesion.fechaSesion | date:'short'}}</small>
              </div>
            </div>
          </div>
          <div class="empty-state" *ngIf="dashboardData.ultimasSesiones.length === 0">
            <mat-icon>sports_esports</mat-icon>
            <p>No hay sesiones registradas a√∫n</p>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Ranking Top 5 -->
      <mat-card class="ranking-card">
        <mat-card-header>
          <mat-card-title>Top 5 Estudiantes</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="ranking-list">
            <div class="ranking-item" *ngFor="let top of dashboardData.ranking.top5">
              <span class="ranking-position" [class.top3]="top.posicion <= 3">
                {{top.posicion}}
              </span>
              <div class="ranking-info">
                <strong>{{top.nombre}}</strong>
              </div>
              <span class="ranking-points">{{top.puntos}} pts</span>
            </div>
          </div>
          <div class="my-ranking">
            <mat-icon>person</mat-icon>
            <span>Tu posici√≥n: <strong>#{{dashboardData.ranking.posicion}}</strong> de {{dashboardData.ranking.total}}</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Beneficios Disponibles -->
      <mat-card class="benefits-card">
        <mat-card-header>
          <mat-card-title>Beneficios Disponibles</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="benefits-grid" *ngIf="dashboardData.beneficiosDisponibles.length > 0">
            <div class="benefit-item" *ngFor="let beneficio of dashboardData.beneficiosDisponibles">
              <img [src]="beneficio.imagenUrl || 'assets/images/default-benefit.png'" [alt]="beneficio.nombre">
              <h4>{{beneficio.nombre}}</h4>
              <p class="benefit-points">{{beneficio.puntosRequeridos}} pts</p>
              <span class="benefit-stock">Stock: {{beneficio.stock}}</span>
            </div>
          </div>
          <div class="empty-state" *ngIf="dashboardData.beneficiosDisponibles.length === 0">
            <mat-icon>card_giftcard</mat-icon>
            <p>No hay beneficios disponibles actualmente</p>
          </div>
        </mat-card-content>
      </mat-card>

    </div>
  </div>
</div>