<div class="dashboards-container">
  <!-- Header -->
  <header class="dashboards-header">
    <div class="header-left">
      <button mat-icon-button class="back-btn" (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <img
        src="assets/images/MIKHUY.png"
        alt="MIKHUY Logo"
        class="header-logo"
      />
    </div>

    <div class="header-center">
      <button mat-raised-button class="dashboard-btn">
        <mat-icon>bar_chart</mat-icon>
        DASHBOARDS
      </button>
    </div>

    <div class="header-right">
      <button mat-icon-button class="icon-btn" [matMenuTriggerFor]="menu">
        <mat-icon>menu</mat-icon>
      </button>

      <mat-menu #menu="matMenu" class="user-menu">
        <button mat-menu-item (click)="logout()">
          <mat-icon>logout</mat-icon>
          <span>Salir</span>
        </button>
      </mat-menu>
    </div>
  </header>

  <!-- Loading Spinner -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner></mat-spinner>
    <p>Cargando datos...</p>
  </div>

  <!-- Error Message -->
  <div class="error-container" *ngIf="error && !loading">
    <mat-icon>error_outline</mat-icon>
    <h3>{{ error }}</h3>
    <button mat-raised-button color="primary" (click)="ngOnInit()">
      <mat-icon>refresh</mat-icon>
      Reintentar
    </button>
  </div>

  <!-- Main Content -->
  <div class="dashboards-content" *ngIf="!loading && !error">
    <!-- Sidebar con lista de estudiantes (solo para profesores) -->
    <div class="sidebar" *ngIf="isTeacher">
      <!-- Search -->
      <div class="search-box">
        <mat-icon>search</mat-icon>
        <input
          type="text"
          placeholder="Buscar estudiante"
          [(ngModel)]="searchQuery"
          (input)="searchStudents()"
        />
      </div>

      <!-- Student List -->
      <mat-list class="student-list">
        <mat-list-item
          *ngFor="let student of filteredStudents"
          [class.active]="selectedStudent?.id === student.id"
          (click)="selectStudent(student)"
        >
          <div class="student-item">
            <div class="student-avatar">
              <img
                [src]="getAvatarUrl(student)"
                [alt]="student.nombre"
                (error)="onAvatarError($event)"
              />
              <mat-icon *ngIf="!student.avatar">account_circle</mat-icon>
            </div>
            <div class="student-info">
              <h4>{{ student.nombre }} {{ student.apellido }}</h4>
              <p>{{ student.grado }} - Sección {{ student.seccion }}</p>
              <span class="points-badge"
                >{{ student.puntosAcumulados || 0 }} pts</span
              >
            </div>
          </div>
        </mat-list-item>
      </mat-list>

    <!-- Dashboard Content -->
    <div class="dashboard-main" *ngIf="selectedStudent && dashboardData">
      <!-- Student Profile Card -->
      <mat-card class="profile-summary">
        <div class="profile-content">
          <div class="profile-avatar">
            <img
              [src]="getAvatarUrl(selectedStudent)"
              [alt]="selectedStudent.nombre"
              (error)="onAvatarError($event)"
            />
            <mat-icon *ngIf="!selectedStudent.avatar">account_circle</mat-icon>
          </div>
          <div class="profile-details">
            <h2>{{ selectedStudent.nombre }} {{ selectedStudent.apellido }}</h2>
            <div class="profile-stats">
              <div class="stat-item">
                <span class="label">Edad:</span>
                <span class="value">{{ selectedStudent.edad }} años</span>
              </div>
              <div class="stat-item">
                <span class="label">Talla:</span>
                <span class="value">{{ selectedStudent.talla }}</span>
              </div>
              <div class="stat-item">
                <span class="label">Peso:</span>
                <span class="value">{{ selectedStudent.peso }}</span>
              </div>
              <div class="stat-item">
                <span class="label">Grado:</span>
                <span class="value"
                  >{{ selectedStudent.grado }} -
                  {{ selectedStudent.seccion }}</span
                >
              </div>
              <div class="stat-item">
                <span class="label">Puntos:</span>
                <span class="value highlight">{{
                  dashboardData.estudiante.puntosAcumulados
                }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="profile-actions">
          <button
            mat-raised-button
            class="download-btn"
            (click)="descargarReporte()"
          >
            <mat-icon>download</mat-icon>
            Descargar reporte
          </button>
          <button mat-raised-button class="email-btn" (click)="enviarCorreo()">
            <mat-icon>email</mat-icon>
            Enviar por correo
          </button>
        </div>
      </mat-card>

      <!-- Estadísticas Generales -->
      <div class="stats-grid">
        <mat-card class="stat-card">
          <mat-icon class="stat-icon points">emoji_events</mat-icon>
          <div class="stat-content">
            <h3>{{ dashboardData.estadisticas.puntosGanados }}</h3>
            <p>Puntos Ganados</p>
          </div>
        </mat-card>

        <mat-card class="stat-card">
          <mat-icon class="stat-icon games">videogame_asset</mat-icon>
          <div class="stat-content">
            <h3>{{ dashboardData.estadisticas.juegosCompletados }}</h3>
            <p>Juegos Completados</p>
          </div>
        </mat-card>

        <mat-card class="stat-card">
          <mat-icon class="stat-icon sessions">schedule</mat-icon>
          <div class="stat-content">
            <h3>{{ dashboardData.estadisticas.totalSesiones }}</h3>
            <p>Total Sesiones</p>
          </div>
        </mat-card>

        <mat-card class="stat-card">
          <mat-icon class="stat-icon ranking">leaderboard</mat-icon>
          <div class="stat-content">
            <h3>#{{ dashboardData.estadisticas.posicionRanking }}</h3>
            <p>Posición Ranking</p>
          </div>
        </mat-card>
      </div>

      <!-- ============================================
     SECCIÓN DE SALUD - Agregar después de stats-grid
     ============================================ -->
<!-- Estado de Salud Actual -->
<ng-container *ngIf="dashboardData?.salud as salud">
  <mat-card class="health-summary-card" *ngIf="salud.medicionActual">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>favorite</mat-icon>
        Estado de Salud
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="health-summary">
        <!-- IMC Gauge -->
        <div class="imc-gauge" *ngIf="salud.estadisticas as stats">
          <svg viewBox="0 0 200 120" class="gauge-svg">
            <path d="M 20 100 A 80 80 0 0 1 100 20" class="gauge-segment bajo-peso" />
            <path d="M 100 20 A 80 80 0 0 1 140 35" class="gauge-segment normal" />
            <path d="M 140 35 A 80 80 0 0 1 165 65" class="gauge-segment sobrepeso" />
            <path d="M 165 65 A 80 80 0 0 1 180 100" class="gauge-segment obesidad" />
            
            <g [attr.transform]="'rotate(' + getIMCAngle(stats.imcActual || 0) + ' 100 100)'">
              <line x1="100" y1="100" x2="100" y2="35" class="gauge-needle" />
              <circle cx="100" cy="100" r="6" class="gauge-center" />
            </g>
          </svg>
          
          <div class="imc-info">
            <h3>{{stats.imcActual | number:'1.1-1'}}</h3>
            <p class="imc-label">Índice de Masa Corporal</p>
            <span class="estado-badge" 
                  [ngClass]="{
                    'bajo-peso': stats.estadoNutricionalActual === 'Bajo peso',
                    'normal': stats.estadoNutricionalActual === 'Normal',
                    'sobrepeso': stats.estadoNutricionalActual === 'Sobrepeso',
                    'obesidad': stats.estadoNutricionalActual === 'Obesidad'
                  }">
              {{stats.estadoNutricionalActual}}
            </span>
          </div>
        </div>

        <!-- Mediciones Actuales -->
        <div class="mediciones-actuales">
          <div class="medicion-card">
            <mat-icon>monitor_weight</mat-icon>
            <div class="medicion-info">
              <h4>{{salud.medicionActual.peso}} kg</h4>
              <p>Peso</p>
              <ng-container *ngIf="salud.estadisticas as stats">
                <span class="variacion" 
                      [ngClass]="{
                        'positivo': stats.variacionPeso > 0,
                        'negativo': stats.variacionPeso < 0
                      }">
                  <mat-icon>{{stats.variacionPeso > 0 ? 'trending_up' : 'trending_down'}}</mat-icon>
                  {{stats.variacionPeso | number:'1.1-1'}}%
                </span>
              </ng-container>
            </div>
          </div>

          <div class="medicion-card">
            <mat-icon>height</mat-icon>
            <div class="medicion-info">
              <h4>{{salud.medicionActual.talla}} cm</h4>
              <p>Talla</p>
              <ng-container *ngIf="salud.estadisticas as stats">
                <span class="variacion positivo" *ngIf="stats.variacionTalla > 0">
                  <mat-icon>trending_up</mat-icon>
                  +{{stats.variacionTalla | number:'1.1-1'}}%
                </span>
              </ng-container>
            </div>
          </div>

          <div class="medicion-card" *ngIf="salud.estadisticas as stats">
            <mat-icon>{{getTendenciaIcon(stats.tendencia)}}</mat-icon>
            <div class="medicion-info">
              <h4>{{stats.tendencia}}</h4>
              <p>Tendencia</p>
              <span class="mediciones-count">
                {{stats.totalMediciones}} mediciones
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Recomendación -->
      <div class="health-recommendation" *ngIf="salud.estadisticas as stats">
        <mat-icon>info</mat-icon>
        <p>{{stats.recomendacion}}</p>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Gráficas de Evolución -->
  <ng-container *ngIf="salud.historialMediciones as mediciones">
    <div class="health-charts-grid" *ngIf="mediciones.length > 0">
      
      <!-- Gráfica de Peso -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Evolución de Peso</mat-card-title>
          <span class="data-source">Últimas {{mediciones.length}} mediciones</span>
        </mat-card-header>
        <mat-card-content>
          <div class="line-chart-container">
            <svg viewBox="0 0 400 200" class="line-chart">
              <line x1="40" y1="20" x2="40" y2="160" class="grid-line" />
              <line x1="40" y1="160" x2="380" y2="160" class="grid-line" />
              
              <polyline 
                [attr.points]="getWeightChartPoints()"
                class="chart-line peso-line" />
              
              <circle *ngFor="let point of getWeightPoints(); let i = index"
                      [attr.cx]="point.x"
                      [attr.cy]="point.y"
                      r="4"
                      class="chart-point peso-point"
                      [matTooltip]="point.peso + ' kg - ' + point.fecha">
              </circle>
              
              <text x="15" y="25" class="chart-label">kg</text>
            </svg>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Gráfica de Talla -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Evolución de Talla</mat-card-title>
          <span class="data-source">Últimas {{mediciones.length}} mediciones</span>
        </mat-card-header>
        <mat-card-content>
          <div class="line-chart-container">
            <svg viewBox="0 0 400 200" class="line-chart">
              <line x1="40" y1="20" x2="40" y2="160" class="grid-line" />
              <line x1="40" y1="160" x2="380" y2="160" class="grid-line" />
              
              <polyline 
                [attr.points]="getHeightChartPoints()"
                class="chart-line talla-line" />
              
              <circle *ngFor="let point of getHeightPoints(); let i = index"
                      [attr.cx]="point.x"
                      [attr.cy]="point.y"
                      r="4"
                      class="chart-point talla-point"
                      [matTooltip]="point.talla + ' cm - ' + point.fecha">
              </circle>
              
              <text x="15" y="25" class="chart-label">cm</text>
            </svg>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Gráfica de IMC -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Evolución del IMC</mat-card-title>
          <span class="data-source">Últimas {{mediciones.length}} mediciones</span>
        </mat-card-header>
        <mat-card-content>
          <div class="line-chart-container">
            <svg viewBox="0 0 400 200" class="line-chart">
              <rect x="40" y="20" width="340" height="35" class="imc-zone bajo-peso" opacity="0.1" />
              <rect x="40" y="55" width="340" height="50" class="imc-zone normal" opacity="0.1" />
              <rect x="40" y="105" width="340" height="30" class="imc-zone sobrepeso" opacity="0.1" />
              <rect x="40" y="135" width="340" height="25" class="imc-zone obesidad" opacity="0.1" />
              
              <line x1="40" y1="20" x2="40" y2="160" class="grid-line" />
              <line x1="40" y1="160" x2="380" y2="160" class="grid-line" />
              
              <text x="45" y="40" class="zone-label">Bajo peso (&lt;18.5)</text>
              <text x="45" y="80" class="zone-label">Normal (18.5-25)</text>
              <text x="45" y="120" class="zone-label">Sobrepeso (25-30)</text>
              <text x="45" y="150" class="zone-label">Obesidad (&gt;30)</text>
              
              <polyline 
                [attr.points]="getIMCChartPoints()"
                class="chart-line imc-line" />
              
              <circle *ngFor="let point of getIMCPoints(); let i = index"
                      [attr.cx]="point.x"
                      [attr.cy]="point.y"
                      r="4"
                      [attr.class]="'chart-point imc-point ' + point.estado"
                      [matTooltip]="'IMC: ' + point.imc + ' (' + point.estado + ') - ' + point.fecha">
              </circle>
              
              <text x="15" y="25" class="chart-label">IMC</text>
            </svg>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </ng-container>
</ng-container>

<!-- Empty state para salud -->
<mat-card class="health-empty-card" *ngIf="!dashboardData?.salud?.medicionActual">
  <mat-card-content>
    <div class="empty-state">
      <mat-icon>monitor_heart</mat-icon>
      <h3>No hay mediciones de salud registradas</h3>
      <p>Actualiza el peso y talla del estudiante en su perfil para comenzar el seguimiento.</p>
      <button mat-raised-button color="primary" (click)="openProfile()">
        <mat-icon>edit</mat-icon>
        Ir al Perfil
      </button>
    </div>
  </mat-card-content>
</mat-card>